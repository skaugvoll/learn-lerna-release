name: Simulate deploy to github environment

on:
  push:
    branches:
      - sisk-environments

jobs:
  sim-deploy:
    name: Simulate a deploy job and tag github environment
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Simulate step that deployes
        run: |
          echo "Simulate deployment, what does the job.environment do now?"
  sim-matrix-deploy-dynamic-envs:
    name: Simulate a deploy job and tag github environment
    runs-on: ubuntu-latest
    environment: dev-${{matrix.package}}
    strategy:
      matrix:
        package:
          - package-a
          - package-b
    steps:
      - name: Simulate step that deployes
        run: |
          echo "Simulate ${{matrix.package}} deployment, what does the job.environment do now?"
  sim-matrix-deploy-static-env:
    name: Simulate a deploy job and tag github environment
    runs-on: ubuntu-latest
    environment: dev-matrix-static
    strategy:
      matrix:
        package:
          - package-a
          - package-b
    steps:
      - name: Simulate step that deployes
        run: |
          echo "Simulate ${{matrix.package}} deployment, what does the job.environment do now?"
  deploy-failes:
    name: simulate that one job deploy-failes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - package: a
            status: 0 # ok
          - package: b
            status: 1 # failes
    steps:
      - name: echo-matrix-values
        run: |
          echo ${{matrix.package}} ${{matrix.status}}
          if [ ${{matrix.status != 0 }} ]
          then
            exit 1
          else
            exit 0
          fi
  set-deploy-status:
    needs: [deploy-failes]
    runs-on: ubuntu-latest
    environment: manual-deploy-mark
    steps:
      - name: mark deploy status
        run: |
          if [ ${{needs.deploy-failes.result != 'success' }}]
          then
            exit 1
          else
            exit 0
          fi
